// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-python"
  output   = "../prisma_client"
}

datasource db {
  provider = "postgresql"
  url      = env("NEON_DB_URL")
}

model Customer {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Authentication fields
  email       String   @unique @db.VarChar(255)
  passwordHash String  @map("password_hash") @db.VarChar(129) // SHA-256 hash (64) + : + salt (64) = 129 chars
  role        String   @default("user") @db.VarChar(20) // user, admin, doctor, etc.
  isActive    Boolean  @default(true) @map("is_active")
  lastLogin   DateTime? @map("last_login")
  
  // Profile information
  age         Int?
  sex         String?  @db.VarChar(20)
  diabetes    Boolean  @default(false)
  hypertension Boolean @default(false)
  pregnancy   Boolean  @default(false)
  city        String?  @db.VarChar(100)
  
  // Additional metadata
  metadata    Json?
  
  // Relationships
  chatSessions ChatSession[]
  refreshTokens  RefreshToken[]
  
  @@index([email])
  @@index([role])
  @@map("customers")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(255)
  customerId String  @map("customer_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revoked   Boolean  @default(false)
  
  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([token])
  @@map("refresh_tokens")
}

model ChatSession {
  id            String   @id @default(uuid())
  customerId    String   @map("customer_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Session metadata
  language      String?  @db.VarChar(10)
  sessionMetadata Json?  @map("session_metadata")
  
  // Relationships
  customer      Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages      ChatMessage[]
  
  @@index([customerId, createdAt])
  @@map("chat_sessions")
}

model ChatMessage {
  id          String   @id @default(uuid())
  sessionId   String   @map("session_id")
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Message content
  role        String   @db.VarChar(20)
  messageText String   @db.Text @map("message_text")
  language    String?  @db.VarChar(10)
  
  // Response data
  route       String?  @db.VarChar(20)
  answer      String?  @db.Text
  
  // Safety and facts
  safetyData  Json?    @map("safety_data")
  facts       Json?
  citations   Json?
  
  // Metadata
  metadata    Json?
  
  // Relationships
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, createdAt])
  @@index([role])
  @@map("chat_messages")
}

